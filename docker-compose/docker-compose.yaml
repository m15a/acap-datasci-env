name: acap-datasci-env

services:
  git:
    build:
      context: ./git
    volumes:
      - git-data:/var/www/git
    ports:
      - "9010:9010"
    restart: always

  versitygw:
    image: versity/versitygw:v1.0.19
    volumes:
      - versitygw-data:/data
    environment:
      ROOT_ACCESS_KEY: versitygw
      ROOT_SECRET_KEY: versitygw
    command: posix /data
    ports:
      - "7070:7070"
    restart: always

  postgres:
    image: postgres:15.15-alpine3.22
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-dbs.sql:/docker-entrypoint-initdb.d/init-dbs.sql
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    restart: always
    healthcheck:
      test: [CMD, pg_isready, -U, prefect]
      interval: 5s
      timeout: 5s
      retries: 5

  mlflow:
    depends_on:
      postgres:
        condition: service_healthy
      versitygw:
        condition: service_started
    build:
      context: ./mlflow
    environment:
      MLFLOW_S3_ENDPOINT_URL: http://versitygw:7070
      MLFLOW_S3_IGNORE_TLS: "true"
      AWS_ACCESS_KEY_ID: versitygw
      AWS_SECRET_ACCESS_KEY: versitygw
      AWS_DEFAULT_REGION: us-east-1
    command: >
      server --host 0.0.0.0
      --backend-store-uri postgresql://mlflow:mlflow@postgres:5432/mlflow
      --artifacts-destination s3://mlflow/artifacts
      --disable-security-middleware
    ports:
      - "5001:5000"
    restart: always

  prefect-server:
    depends_on:
      postgres:
        condition: service_healthy
    build:
      context: ./prefect/server
    environment:
      PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://prefect:prefect@postgres:5432/prefect
    ports:
      - "4200:4200"
    restart: always
    healthcheck:
      test: [CMD, python, -c, "import urllib.request;urllib.request.urlopen('http://localhost:4200/health')"]
      interval: 5s
      timeout: 5s
      retries: 5

  prefect-worker:
    depends_on:
      prefect-server:
        condition: service_healthy
    build:
      context: ./prefect/worker
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
      AWS_ENDPOINT_URL: http://versitygw:7070
      AWS_ACCESS_KEY_ID: versitygw
      AWS_SECRET_ACCESS_KEY: versitygw
      AWS_DEFAULT_REGION: us-east-1
    command: prefect worker start --type process --pool sandbox
    restart: always

  marimo:
    build:
      context: ./marimo
    ports:
      - "2718:2718"
    volumes:
      - ..:/work
    environment:
      PREFECT_API_URL: http://prefect-server:4200/api
      AWS_ENDPOINT_URL: http://versitygw:7070
      AWS_ACCESS_KEY_ID: versitygw
      AWS_SECRET_ACCESS_KEY: versitygw
      AWS_DEFAULT_REGION: us-east-1
      LANG: C.UTF-8
    restart: always

volumes:
  git-data:
  versitygw-data:
  postgres-data:
